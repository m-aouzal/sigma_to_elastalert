description: |
  Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the code block cited in the reference section below
name: Invoke-Obfuscation Obfuscated IEX Invocation - PowerShell Module
index: "winlogbeat-*"
filter:
- query:
    query_string:
      query: winlog.event_data.payload.keyword:/\$pshome\[\s*\d{1,3}\s*\]\s*\+\s*\$pshome\[/ OR winlog.event_data.payload.keyword:/\$shellid\[\s*\d{1,3}\s*\]\s*\+\s*\$shellid\[/ OR winlog.event_data.payload.keyword:/\$env:public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:public\[/ OR winlog.event_data.payload.keyword:/\$env:comspec\[(\s*\d{1,3}\s*,){2}/ OR winlog.event_data.payload.keyword:/\*mdr\*\w\s*\)\.name/ OR winlog.event_data.payload.keyword:/\$verbosepreference\.tostring\(/ OR winlog.event_data.payload.keyword:/\[string\]\s*\$verbosepreference/
type: any
priority: 3
