description: |
  Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the code block linked in the references
name: Invoke-Obfuscation Obfuscated IEX Invocation - System
index: "winlogbeat-*"
filter:
- query:
    query_string:
      query: winlog.channel.keyword:System AND (event.code.keyword:7045 AND (winlog.event_data.imagepath.keyword:/$pshome[s*d{1,3}s*]s*+s*$pshome[/ OR winlog.event_data.imagepath.keyword:/$shellid[s*d{1,3}s*]s*+s*$shellid[/ OR winlog.event_data.imagepath.keyword:/$env:public[s*d{1,3}s*]s*+s*$env:public[/ OR winlog.event_data.imagepath.keyword:/$env:comspec[(s*d{1,3}s*,){2}/ OR winlog.event_data.imagepath.keyword:/*mdr*ws*).name/ OR winlog.event_data.imagepath.keyword:/$verbosepreference.tostring(/ OR winlog.event_data.imagepath.keyword:/string]s*$verbosepreference/))
type: any
priority: 3
